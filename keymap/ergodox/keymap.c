#include QMK_KEYBOARD_H
#include "version.h"
#include "timer.h"
#include "keymap_french.h"
#include "tap_dance.h"

enum custom_keycodes {
    PM_SCRL = SAFE_RANGE,
    PM_FACT
};

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

/*
 * ,--------------------------------------------------------------.    ,--------------------------------------------------------------.
 * |    0   |    1   |    2   |    3   |    4   |    5   |   6    |    |   38   |   39   |   40   |   41   |   42   |   43   |   44   |
 * |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
 * |    7   |    8   |    9   |   10   |   11   |   12   |   13   |    |   45   |   46   |   47   |   48   |   49   |   50   |   51   |
 * |--------+--------+--------+--------+--------+--------|        |    |        |--------+--------+--------+--------+--------+--------|
 * |   14   |   15   |   16   |   17   |   18   |   19   | ------ |    | ------ |   52   |   53   |   54   |   55   |   56   |   57   |
 * |--------+--------+--------+--------+--------+--------|   26   |    |   58   |--------+--------+--------+--------+--------+--------|
 * |   20   |   21   |   22   |   23   |   24   |   25   |        |    |        |   59   |   60   |   61   |   62   |   63   |   64   |
 * |--------+-----------------+--------+--------+--------+--------'    `--------+--------+--------+--------+--------+--------+--------|
 * |   27   |   28   |   29   |   30   |   31   |                                        |   65   |   66   |   67   |   68   |   69   |
 * `--------------------------------------------'                                        `--------------------------------------------'
 *                                              ,-----------------.    ,-----------------.
 *                                              |   32   |   33   |    |   70   |   71   |
 *                                     ,--------+--------+--------|    |--------+--------+--------.
 *                                     |        |        |   34   |    |   72   |        |        |
 *                                     |   35   |   36   |--------|    |--------|   74   |   75   |
 *                                     |        |        |   37   |    |   73   |        |        |
 *                                     `--------------------------'    `--------------------------'
 *   _______, _______, _______, _______, _______, _______, _______,      _______, _______, _______, _______, _______, _______, _______,
 *   _______, _______, _______, _______, _______, _______, _______,      _______, _______, _______, _______, _______, _______, _______,
 *   _______, _______, _______, _______, _______, _______,                        _______, _______, _______, _______, _______, _______,
 *   _______, _______, _______, _______, _______, _______, _______,      _______, _______, _______, _______, _______, _______, _______,
 *   _______, _______, _______, _______, _______,                                          _______, _______, _______, _______, _______,
 *
 *                                                _______, _______,      _______, _______,
 *                                                         _______,      _______,
 *                                       _______, _______, _______,      _______, _______, _______
 */

[0] = LAYOUT_ergodox_pretty(
// ,--------------------------------------------------------------.    ,--------------------------------------------------------------.
     _______, _______, _______, _______, _______, _______, _______,      _______, _______, _______, _______, _______, FR_MINS, FR_EQL ,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     _______, FR_Q   , FR_W   , FR_E   , FR_R   , FR_T   , AG_FR_C,      AG_FR_C, FR_Y   , FR_U   , FR_I   , FR_O   , FR_P   , FR_BSLS,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     _______, FR_A   , FR_S   , FR_D   , LT2_F  , LT1_G  ,                        FR_H   , FR_J   , FR_K   , FR_L   , LT2_COL, FR_QUOT,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     KC_LSFT, FR_Z   , FR_X   , FR_C   , FR_V   , LT3_B  , C(FR_B),      C(FR_B), FR_N   , LT1_M  , FR_COMM, FR_DOT , FR_SLSH, FR_GRV ,
// |--------+-----------------+--------+--------+--------+--------'    `--------+--------+--------+--------+--------+--------+--------|
     KC_LCTL, KC_LGUI, KC_LALT, _______, KC_ESC ,                                          TD_LCTL, _______, _______, _______, _______,
// `--------------------------------------------'                                        `--------------------------------------------'

//                                              ,-----------------.    ,-----------------.
                                                  _______, KC_HOME,      KC_PGUP, TT(1)  ,
//                                     ,--------+--------+--------|    |--------+--------+--------.
                                                           KC_END ,      KC_PGDN,
//                                     |        |        |--------|    |--------|        |        |
                                         KC_SPC , KC_TAB , PM_SCRL,      _______, KC_ENT , KC_BSPC
//                                     `--------------------------'    `--------------------------'
),

[1] = LAYOUT_ergodox_pretty(
// ,--------------------------------------------------------------.    ,--------------------------------------------------------------.
     _______, KC_F1  , KC_F2  , KC_F3  , KC_F4  , KC_F5  , CSG_NO ,      KC_F6  , KC_F7  , KC_F8  , KC_F9  , KC_F10 , KC_F11 , KC_F12 ,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     _______, FR_EXLM, FR_AT  , FR_LCBR, FR_RCBR, FR_PIPE, _______,      _______, _______, _______, _______, _______, FR_ASTR, _______,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     _______, FR_HASH, FR_DLR , FR_LPRN, FR_RPRN, _______,                        KC_LEFT, KC_DOWN, KC_UP  , KC_RGHT, FR_PLUS, _______,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     CAPSWRD, FR_PERC, FR_CIRC, FR_LBRC, FR_RBRC, FR_TILD, _______,      _______, FR_AMPR, _______, _______, _______, FR_BSLS, _______,
// |--------+--------+--------+--------+--------+--------+--------'    `--------+--------+--------+--------+--------+--------+--------|
     _______, _______, _______, _______, _______,                                          _______, _______, _______, FR_EQL , _______,
// `--------------------------------------------'                                        `--------------------------------------------'

//                                              ,-----------------.    ,-----------------.
                                                  CG_NORM, KC_PGUP,      _______, _______,
//                                     ,--------+--------+--------|    |--------+--------+--------.
                                                           KC_PGDN,      _______,
//                                     |        |        |--------|    |--------|        |        |
                                         _______, _______, _______,      _______, _______, _______
//                                     `--------------------------'    `--------------------------'
),

[2] = LAYOUT_ergodox_pretty(
// ,--------------------------------------------------------------.    ,--------------------------------------------------------------.
     _______, _______, _______, _______, _______, _______, _______,      _______, _______, _______, _______, _______, _______, _______,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     _______, _______, KC_BRIU, _______, _______, _______, _______,      _______, _______, _______, _______, _______, _______, _______,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     _______, _______, KC_BRID, _______, _______, PM_FACT,                        KC_WH_L, KC_WH_D, KC_WH_U, KC_WH_R, _______, _______,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     KC_CAPS, _______, _______, _______, _______, _______, _______,      _______, _______, KC_MPRV, KC_MNXT, KC_MPLY, _______, _______,
// |--------+--------+--------+--------+--------+--------+--------'    `--------+--------+--------+--------+--------+--------+--------|
     QK_BOOT, _______, _______, _______, _______,                                          KC_VOLD, KC_VOLU, KC_MUTE, _______, _______,
// `--------------------------------------------'                                        `--------------------------------------------'

//                                              ,-----------------.    ,-----------------.
                                                  _______, _______,      _______, _______,
//                                     ,--------+--------+--------|    |--------+--------+--------.
                                                           _______,      _______,
//                                     |        |        |--------|    |--------|        |        |
                                         KC_BTN2, KC_BTN1, KC_BTN3,      _______, KC_BTN4, KC_BTN5
//                                     `--------------------------'    `--------------------------'
),

[3] = LAYOUT_ergodox_pretty(
// ,--------------------------------------------------------------.    ,--------------------------------------------------------------.
     _______, _______, _______, _______, _______, _______, _______,      _______, _______, _______, _______, _______, _______, _______,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     _______, _______, _______, _______, _______, _______, _______,      _______, _______, FR_7   , FR_8   , FR_9   , _______, _______,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     _______, _______, _______, _______, _______, _______,                        _______, FR_4   , FR_5   , FR_6   , _______, _______,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     _______, _______, _______, _______, _______, _______, _______,      _______, _______, FR_1   , FR_2   , FR_3   , _______, _______,
// |--------+--------+--------+--------+--------+--------+--------|    |--------+--------+--------+--------+--------+--------+--------|
     _______, _______, _______, _______, _______,                                          _______, _______, FR_0   , _______, _______,
// `--------------------------------------------'                                        `--------------------------------------------'

//                                              ,-----------------.    ,-----------------.
                                                  _______, _______,      _______, _______,
//                                     ,--------+--------+--------|    |--------+--------+--------.
                                                           _______,      _______,
//                                     |        |        |--------|    |--------|        |        |
                                         _______, _______, _______,      _______, _______, _______
//                                     `--------------------------'    `--------------------------'
)
};

/* === TrackBall === */

bool     set_scrolling = false;
int      factor        = 4;

void next_factor(keyrecord_t *record) {
    if (record->event.pressed) {
        switch(factor) {
            case 1:
                factor = 4;
                break;
            case 4:
                factor = 8;
                break;
            case 8:
                factor = 1;
                break;
        }
    }
}

/* === PROCESS === */
bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    switch (keycode) {
        case PM_SCRL:
            set_scrolling = record->event.pressed;
            break;
        case PM_FACT:
            next_factor(record);
            break;
    }
    return true;
};

void post_process_record_user(uint16_t keycode, keyrecord_t *record) {
    if (set_scrolling) {
        pimoroni_trackball_set_rgbw(255, 0, 0, 0);
    } else if (factor == 1) {
        pimoroni_trackball_set_rgbw(0, 127, 127, 0);
    } else if (factor == 8) {
        pimoroni_trackball_set_rgbw(0, 255, 255, 0);
    } else if (is_caps_word_on()) {
        pimoroni_trackball_set_rgbw(255, 255, 0, 0);
    } else {
        pimoroni_trackball_set_rgbw(0, 0, 0, 0);
    }
}

/* === RGB === */

// Runs just one time when the keyboard initializes.
void keyboard_post_init_user(void) {
    // Customise these values to desired behaviour
    // debug_enable=true;
    // debug_matrix=true;
    // debug_keyboard=true;
    // debug_mouse=true;
};

report_mouse_t pointing_device_task_user(report_mouse_t mouse_report) {
    if (set_scrolling) {
        mouse_report.h = (mouse_report.x > 0) ? 1 : ((mouse_report.x < 0) ? -1 : 0);
        mouse_report.v = (mouse_report.y > 0) ? -1 : ((mouse_report.y < 0) ? 1 : 0);
        mouse_report.x = mouse_report.y = 0;
    } else {
        mouse_report.x = mouse_report.x * factor;
        mouse_report.y = mouse_report.y * factor;
    }
    return mouse_report;
}

bool caps_word_press_user(uint16_t keycode) {
    switch (keycode) {
        // Keycodes that continue Caps Word, with shift applied.
        case KC_A ... KC_Z:
        case FR_M:
            add_weak_mods(MOD_BIT(KC_LSFT));
            return true;

        // Keycodes that continue Caps Word, without shifting.
        case FR_0:
        case FR_1:
        case FR_2:
        case FR_3:
        case FR_4:
        case FR_5:
        case FR_6:
        case FR_7:
        case FR_8:
        case FR_9:
        case KC_BSPC:
        case KC_DEL:
        case FR_UNDS:
        case KC_LSFT:
        case LT3_B:
        case FR_MINS:
            return true;

        default:
            return false;  // Deactivate Caps Word.
    }
}
